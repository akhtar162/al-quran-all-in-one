
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Aplikasi Islami Lengkap</title>
<!-- Tailwind CSS for styling -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google Fonts for typography -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
<!-- Leaflet JS for Maps -->
<link crossorigin="" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" rel="stylesheet"/>
<script crossorigin="" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet Routing Machine for real-time tracking -->
<link href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<!-- Custom Styles -->
<link href="style.css" rel="stylesheet"/>
<style>
    /* Style for the Qibla compass */
    .compass {
        position: relative;
        width: 200px;
        height: 200px;
        background: url('https://i.imgur.com/J82sV2R.png') no-repeat center center; /* Compass background image */
        background-size: contain;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .compass-needle {
        position: absolute;
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 80px solid #f59e0b; /* Amber color for needle */
        transform-origin: bottom center;
        transition: transform 0.5s ease-out;
    }
    .compass-center {
        width: 20px;
        height: 20px;
        background-color: #fff;
        border-radius: 50%;
        z-index: 10;
    }
    /* Style for the Mosque Finder map */
    #map {
        height: 450px;
    }
</style>
</head>
<body class="bg-gradient-to-br from-emerald-900 to-green-900 text-gray-100">
<!-- Loading Spinner -->
<div class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden" id="loading-spinner">
<div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-amber-400"></div>
</div>
<!-- Main Container -->
<div class="container mx-auto p-4 min-h-screen">
<!-- Header -->
<header class="text-center mb-6">
<h1 class="text-4xl font-bold text-amber-400">Oase Islami</h1>
<p class="text-amber-200">Panduan Digital Muslim Terlengkap</p>
</header>
<!-- Navigation -->
<nav class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-9 gap-2 mb-6 text-center">
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300 active" data-target="quran">Al-Quran</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="hadits">Hadits</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="sholat">Jadwal Sholat</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="kiblat">Arah Kiblat</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="masjid">Masjid Terdekat</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="tasbih">Tasbih</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="zakat">Kalkulator Zakat</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="panduan">Panduan Sholat</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="pencarian">Cari Ayat</button>
<!-- Tombol baru -->
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="doa">Doa Harian</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="hijaiyah">Latihan Hijaiyah</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="bookmark">Bookmark</button>
<button class="nav-item p-2 rounded-lg bg-emerald-700 hover:bg-amber-500 hover:text-emerald-900 transition-all duration-300" data-target="hijriah">Kalender Hijriah</button>
</nav>
<!-- Content Sections -->
<main>
<!-- Al-Quran Section -->
<section class="content-section" id="quran-section">
<div id="surah-list-view">
<h2 class="text-2xl font-bold text-amber-400 mb-4">Daftar Surah</h2>
<div class="bg-emerald-800 bg-opacity-50 p-4 rounded-lg mb-4">
    <p class="text-sm text-amber-200 mb-2">Pilih sumber data Al-Quran:</p>
    <div class="flex flex-wrap gap-2">
        <button class="api-source px-3 py-1 bg-amber-500 text-emerald-900 font-bold rounded-lg text-sm" data-source="alquran-cloud">Alquran.cloud</button>
        <button class="api-source px-3 py-1 bg-emerald-700 text-white font-bold rounded-lg text-sm" data-source="santrikoding">Santrikoding</button>
    </div>
</div>
<div id="api-error-message" class="error-message hidden">
    <p class="text-red-400">Gagal memuat data dari API. Silakan coba lagi atau gunakan sumber data lain.</p>
    <button class="retry-button" id="retry-api-btn">Coba Lagi</button>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="surah-list">
<!-- Surah cards will be populated here -->
</div>
</div>
<div class="hidden" id="surah-detail-view">
<button class="mb-4 px-4 py-2 bg-amber-500 text-emerald-900 font-bold rounded-lg hover:bg-amber-400 transition" id="back-to-surah-list">Kembali</button>
<div class="bg-emerald-800 bg-opacity-50 p-6 rounded-lg" id="surah-detail-content"></div>
</div>
</section>
<!-- Hadits Section -->
<section class="content-section hidden" id="hadits-section">
<h2 class="text-2xl font-bold text-amber-400 mb-4">Pencarian Hadits</h2>
<div class="flex flex-wrap gap-4 mb-4 bg-emerald-800 p-4 rounded-lg">
<select class="bg-emerald-700 text-white p-2 rounded-lg flex-grow" id="hadits-perawi">
<option value="bukhari">Bukhari</option>
<option value="muslim">Muslim</option>
<option value="abu-daud">Abu Daud</option>
<option value="tirmidzi">Tirmidzi</option>
<option value="nasai">An-Nasa'i</option>
<option value="ibnu-majah">Ibnu Majah</option>
<option value="ahmad">Ahmad</option>
<option value="darimi">Darimi</option>
<option value="malik">Malik</option>
</select>
<input class="bg-emerald-700 text-white p-2 rounded-lg flex-grow" id="hadits-start" placeholder="No. Hadits (contoh: 50)" type="number"/>
<button class="px-4 py-2 bg-amber-500 text-emerald-900 font-bold rounded-lg hover:bg-amber-400 transition flex-grow sm:flex-grow-0" id="search-hadits-btn">Cari</button>
</div>
<div class="space-y-4" id="hadits-result"></div>
</section>
<!-- Jadwal Sholat Section -->
<section class="content-section hidden" id="sholat-section">
<h2 class="text-2xl font-bold text-amber-400 mb-4">Jadwal Sholat</h2>
<div class="flex flex-wrap gap-4 mb-4 bg-emerald-800 p-4 rounded-lg">
<input class="bg-emerald-700 text-white p-2 rounded-lg flex-grow" id="sholat-city" placeholder="Masukkan nama kota (contoh: Jakarta)" type="text"/>
<button class="px-4 py-2 bg-amber-500 text-emerald-900 font-bold rounded-lg hover:bg-amber-400 transition flex-grow sm:flex-grow-0" id="search-sholat-btn">Cari Jadwal</button>
</div>
<div id="sholat-result"></div>
</section>
<!-- Arah Kiblat Section -->
<section class="content-section hidden text-center" id="kiblat-section">
<h2 class="text-2xl font-bold text-amber-400 mb-4">Arah Kiblat</h2>
<div class="flex flex-col items-center justify-center p-6 bg-emerald-800 rounded-lg" id="qibla-container">
<p class="mb-4" id="qibla-instruction">Klik tombol di bawah untuk memulai. Arahkan bagian atas ponsel Anda ke arah panah.</p>
<div class="compass mb-4">
<div class="compass-needle" id="compass-needle"></div>
<div class="compass-center"></div>
</div>
<div class="text-lg font-semibold text-amber-300" id="qibla-info"></div>
<button class="mt-4 px-6 py-3 bg-amber-500 text-emerald-900 font-bold rounded-lg hover:bg-amber-400 transition" id="start-qibla-btn">Mulai Deteksi Kiblat</button>
</div>
</section>
<!-- Masjid Terdekat Section -->
<section class="content-section hidden" id="masjid-section">
<h2 class="text-2xl font-bold text-amber-400 mb-4">Masjid Terdekat</h2>
<div class="bg-emerald-800 p-4 rounded-lg">
<div id="location-permission" class="location-permission hidden">
    <p class="text-amber-300">Aplikasi membutuhkan izin lokasi untuk menemukan masjid terdekat. Silakan berikan izin lokasi pada browser Anda.</p>
    <button class="permission-button" id="request-location-btn">Berikan Izin Lokasi</button>
</div>
<div class="mb-4 bg-emerald-700 p-3 rounded-lg">
    <p class="text-amber-200 mb-2">Pengaturan Pencarian:</p>
    <div class="flex flex-wrap gap-4 items-center">
        <div class="flex items-center gap-2">
            <label for="search-radius" class="text-sm">Radius:</label>
            <select id="search-radius" class="bg-emerald-600 text-white p-1 rounded text-sm">
                <option value="1000">1 km</option>
                <option value="2000">2 km</option>
                <option value="3000" selected>3 km</option>
                <option value="5000">5 km</option>
            </select>
        </div>
        <div class="flex items-center gap-2">
            <label for="max-results" class="text-sm">Jumlah Maks:</label>
            <select id="max-results" class="bg-emerald-600 text-white p-1 rounded text-sm">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="14" selected>14</option>
                <option value="20">20</option>
            </select>
        </div>
    </div>
</div>
<button class="w-full px-4 py-2 bg-amber-500 text-emerald-900 font-bold rounded-lg hover:bg-amber-400 transition mb-4" id="find-mosques-btn">Temukan Masjid di Sekitar Saya</button>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="md:col-span-2" id="map-container">
<div id="map"></div>
</div>
<div class="max-h-[450px] overflow-y-auto" id="mosque-list-container">
<!-- Mosque list will be populated here -->
<p class="text-center text-gray-400" id="mosque-list-placeholder">Daftar masjid akan muncul di sini setelah pencarian.</p>
</div>
</div>
</div>
</section>
<!-- Tasbih Section -->
<section class="content-section hidden" id="tasbih-section">
<h2 class="text-2xl font-bold text-amber-400 mb-4 text-center">Tasbih Digital</h2>
<div class="flex flex-col items-center justify-center p-8 bg-emerald-800 rounded-full w-64 h-64 mx-auto shadow-2xl">
<div class="text-7xl font-bold text-amber-300" id="tasbih-count">0</div>
</div>
<div class="flex justify-center gap-4 mt-6">
<button class="w-24 h-24 bg-amber-500 text-emerald-900 text-4xl font-bold rounded-full hover:bg-amber-400 transition transform hover:scale-105 active:scale-95" id="tasbih-increment-btn">+</button>
<button class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-500 transition" id="tasbih-reset-btn">Reset</button>
</div>
</section>
<!-- Kalkulator Zakat Section -->
<section class="content-section hidden" id="zakat-section">
<h2 class="text-2xl font-bold text-amber-400 mb-4">Kalkulator Zakat</h2>
<div class="bg-emerald-800 p-6 rounded-lg">
<div class="mb-4 border-b-2 border-amber-500">
<h3 class="text-xl text-amber-300 font-semibold mb-2">Zakat Profesi/Penghasilan</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<input class="bg-emerald-700 p-2 rounded" id="zakat-profesi-income" placeholder="Pendapatan per bulan (Rp)" type="number"/>
<input class="bg-emerald-700 p-2 rounded" id="zakat-profesi-gold-price" placeholder="Harga emas per gram (Rp)" type="number" value="1300000"/>
</div>
<button class="mt-4 px-4 py-2 bg-amber-500 text-emerald-900 font-bold rounded-lg" id="calculate-profesi-btn">Hitung</button>
<div class="mt-2 text-lg" id="zakat-profesi-result"></div>
</div>
<div class="mb-4 border-b-2 border-amber-500 pb-4">
<h3 class="text-xl text-amber-300 font-semibold mb-2">Zakat Maal (Harta)</h3>
<input class="bg-emerald-700 p-2 rounded w-full" id="zakat-maal-wealth" placeholder="Total harta yang tersimpan 1 tahun (Rp)" type="number"/>
<button class="mt-4 px-4 py-2 bg-amber-500 text-emerald-900 font-bold rounded-lg" id="calculate-maal-btn">Hitung</button>
<div class="mt-2 text-lg" id="zakat-maal-result"></div>
</div>
<div>
<h3 class="text-xl text-amber-300 font-semibold mb-2">Zakat Fitrah</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<input class="bg-emerald-700 p-2 rounded" id="zakat-fitrah-people" placeholder="Jumlah orang" type="number"/>
<input class="bg-emerald-700 p-2 rounded" id="zakat-fitrah-rice-price" placeholder="Harga beras per kg (Rp)" type="number" value="15000"/>
</div>
<button class="mt-4 px-4 py-2 bg-amber-500 text-emerald-900 font-bold rounded-lg" id="calculate-fitrah-btn">Hitung</button>
<div class="mt-2 text-lg" id="zakat-fitrah-result"></div>
</div>
</div>
</section>
<!-- Panduan Sholat Section -->
<section class="content-section hidden" id="panduan-section">
<h2 class="text-2xl font-bold text-amber-400 mb-4">Panduan Praktis Sholat</h2>
<div class="space-y-4">
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">1. Niat</h3>
<p>Berdiri tegak menghadap Kiblat dan memantapkan niat di dalam hati untuk melaksanakan sholat.</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">2. Takbiratul Ihram</h3>
<p>Mengangkat kedua tangan sejajar telinga (pria) atau dada (wanita) sambil mengucapkan "Allahu Akbar".</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">3. Membaca Doa Iftitah dan Al-Fatihah</h3>
<p>Bersedekap, membaca doa Iftitah, kemudian membaca surah Al-Fatihah, diakhiri dengan "Aamiin".</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">4. Membaca Surah Pendek</h3>
<p>Membaca surah atau beberapa ayat dari Al-Quran.</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">5. Ruku'</h3>
<p>Mengangkat tangan sambil bertakbir, lalu membungkuk dengan punggung lurus, dan membaca tasbih ruku'.</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">6. I'tidal</h3>
<p>Bangun dari ruku' sambil mengucapkan "Sami'allahu liman hamidah", lalu membaca "Rabbana lakal hamd".</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">7. Sujud</h3>
<p>Bertakbir lalu turun untuk sujud dengan 7 anggota badan menyentuh lantai, dan membaca tasbih sujud.</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">8. Duduk di Antara Dua Sujud</h3>
<p>Bangun dari sujud sambil bertakbir, duduk, dan membaca doa.</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">9. Sujud Kedua</h3>
<p>Melakukan sujud kedua seperti sujud pertama.</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">10. Tasyahud (Tahiyat)</h3>
<p>Duduk tasyahud awal (pada rakaat kedua) atau tasyahud akhir (pada rakaat terakhir) dan membaca doa tasyahud.</p>
</div>
<div class="bg-emerald-800 p-4 rounded-lg">
<h3 class="font-semibold text-lg text-amber-300">11. Salam</h3>
<p>Menoleh ke kanan sambil mengucapkan "Assalamualaikum wa rahmatullah", kemudian menoleh ke kiri dengan ucapan yang sama.</p>
</div>
</div>
</section>
<!-- Pencarian Ayat Section -->
<section class="content-section hidden" id="pencarian-section">
<h2 class="text-2xl font-bold text-amber-400 mb-4">Pencarian Ayat Inovatif</h2>
<div class="bg-emerald-800 p-4 rounded-lg">
<input class="bg-emerald-700 text-white p-2 rounded-lg w-full mb-4" id="ayat-search-input" placeholder="Cari berdasarkan topik atau kata kunci (misal: sabar, surga, zakat)" type="text"/>
<p class="text-sm text-amber-200 mb-4">Fitur ini akan mencari kata kunci di seluruh terjemahan Al-Quran. Hasil maksimal 8 ayat untuk performa lebih baik di perangkat lama.</p>
<div class="space-y-4 max-h-96 overflow-y-auto" id="ayat-search-results"></div>
</div>
</section>
<!-- Doa Harian Section -->
<section class="content-section hidden" id="doa-section">
<h2 class="text-2xl font-bold text-amber-400 mb-4">Kumpulan Doa Harian</h2>
<div class="bg-emerald-800 p-4 rounded-lg mb-4">
<select class="bg-emerald-700 text-white p-2 rounded-lg w-full mb-4" id="doa-category">
<option value="">Pilih Kategori Doa</option>
<option value="makanan">Doa Sebelum & Sesudah Makan</option>
<option value="tidur">Doa Sebelum & Sesudah Tidur</option>
<option value="rumah">Doa Masuk & Keluar Rumah</option>
<option value="wc">Doa Masuk & Keluar WC</option>
<option value="pakaian">Doa Memakai Pakaian</option>
</select>
<button class="px-4 py-2 bg-amber-500 text-emerald-900 font-bold rounded-lg" id="load-doa-btn">Tampilkan Doa</button>
</div>
<div class="space-y-4" id="doa-list">
<!-- Doa cards will be populated here -->
</div>
</section>
<!-- Latihan Hijaiyah Section -->
<section class="content-section hidden" id="hijaiyah-section">
<div class="hijaiyah-container">
    <div class="hijaiyah-header">
        <h2 class="hijaiyah-title text-3xl">Latihan Huruf Hijaiyah</h2>
        <p class="hijaiyah-subtitle">Tulis huruf hijaiyah dengan benar untuk melatih kemampuan menulis Arab Anda</p>
    </div>
    
    <div class="hijaiyah-controls">
        <div class="target-letter-container">
            <p class="target-label">Huruf Target:</p>
            <div class="target-letter" id="targetLetter">ÿß</div>
        </div>
        <div class="control-buttons">
            <button class="hijaiyah-button next-button" id="nextButton">Huruf Selanjutnya</button>
            <button class="hijaiyah-button clear-button" id="clearButton">Hapus</button>
        </div>
    </div>
    
    <div class="canvas-container">
        <canvas id="drawingCanvas" width="500" height="500"></canvas>
    </div>
    
    <div class="feedback-container">
        <h3 class="feedback-title">Hasil Penilaian</h3>
        <p class="feedback-text" id="feedbackText">Silakan gambar huruf target di atas kanvas.</p>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        <div class="score-display">
            <span class="current-score" id="currentScore">0%</span>
            <span class="target-score">Target: 53%</span>
        </div>
    </div>
    
    <div class="hijaiyah-progress">
        <h4 class="progress-title">Progress Latihan</h4>
        <div class="letters-grid" id="lettersGrid">
            <!-- Letters will be populated here -->
        </div>
    </div>
</div>
</section>
<!-- Bookmark Section -->
<section class="content-section hidden" id="bookmark-section">
    <h2 class="text-2xl font-bold text-amber-400 mb-4">Ayat yang Ditandai</h2>
    <div class="space-y-4" id="bookmark-list">
        <!-- Bookmarked ayahs will be populated here -->
    </div>
</section>
<!-- Kalender Hijriah Section -->
<section class="content-section hidden" id="hijriah-section">
    <h2 class="text-2xl font-bold text-amber-400 mb-4 text-center">Kalender Hijriah & Masehi</h2>
    <div class="bg-emerald-800 p-4 rounded-lg">
        <div class="flex justify-between items-center mb-4">
            <button id="prev-month-btn" class="px-4 py-2 bg-emerald-700 rounded-lg hover:bg-amber-500 transition-colors">&lt; Sebelumnya</button>
            <h3 id="hijri-month-year" class="text-xl font-bold text-amber-300 text-center"></h3>
            <button id="next-month-btn" class="px-4 py-2 bg-emerald-700 rounded-lg hover:bg-amber-500 transition-colors">Berikutnya &gt;</button>
        </div>
        <div id="hijri-calendar-grid" class="grid grid-cols-7 gap-1 text-center">
            <!-- Calendar will be populated here -->
        </div>
        <p class="text-xs text-center text-gray-400 mt-4">Data kalender disediakan oleh Aladhan API. Mungkin terdapat sedikit perbedaan dengan penentuan tanggal lokal.</p>
    </div>
</section>
</main>
</div>
<!-- Global Murottal Player -->
<div id="global-player" class="fixed bottom-0 left-0 right-0 bg-emerald-900 border-t-2 border-amber-500 p-3 transform translate-y-full transition-transform duration-300 ease-in-out z-30">
    <div class="container mx-auto flex items-center justify-between gap-4">
        <div class="text-sm overflow-hidden whitespace-nowrap">
            <p id="player-surah-info" class="font-bold text-amber-300 truncate">Memuat...</p>
            <p id="player-status" class="text-gray-400">Berhenti</p>
        </div>
        <div class="flex items-center gap-3 flex-shrink-0">
            <button id="player-prev-btn" class="text-xl hover:text-amber-400 transition-colors">‚èÆÔ∏è</button>
            <button id="player-play-pause-btn" class="text-3xl hover:text-amber-400 transition-colors">‚ñ∂Ô∏è</button>
            <button id="player-next-btn" class="text-xl hover:text-amber-400 transition-colors">‚è≠Ô∏è</button>
            <button id="player-stop-btn" class="text-red-500 hover:text-red-400 transition-colors font-bold text-2xl leading-none">‚èπ</button>
        </div>
    </div>
</div>
<!-- Modal for Tafsir -->
<div class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-40 hidden p-4" id="tafsir-modal">
<div class="bg-emerald-800 p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold text-amber-400" id="tafsir-modal-title">Tafsir</h3>
<button class="text-2xl font-bold" id="close-tafsir-modal">√ó</button>
</div>
<div class="text-gray-200 text-justify" id="tafsir-modal-content"></div>
</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');
        const loadingSpinner = document.getElementById('loading-spinner');
        const apiErrorMessage = document.getElementById('api-error-message');
        const retryApiBtn = document.getElementById('retry-api-btn');
        
        let allQuranData = null; // Cache for Quran data for search
        let currentApiSource = 'alquran-cloud'; // Default API source
        let tajwidEnabled = false; // Track if tajwid coloring is enabled

        // Masjid Finder variables
        let map = null;
        let userMarker = null;
        let routingControl = null;
        let mosqueMarkers = [];
        let isMapInitialized = false;
        const findMosquesBtn = document.getElementById('find-mosques-btn');
        const mosqueListContainer = document.getElementById('mosque-list-container');
        const locationPermissionDiv = document.getElementById('location-permission');
        const requestLocationBtn = document.getElementById('request-location-btn');

        // Doa Harian variables
        const loadDoaBtn = document.getElementById('load-doa-btn');
        const doaCategory = document.getElementById('doa-category');
        const doaListContainer = document.getElementById('doa-list');

        // Bookmark variables
        const bookmarkListContainer = document.getElementById('bookmark-list');
        let db;
        const DB_NAME = 'islamic_app_db';
        const DB_VERSION = 1;

        // Murottal player variables
        // --- Global Murottal Player Variables ---
        const globalPlayer = document.getElementById('global-player');
        const playerInfo = document.getElementById('player-surah-info');
        const playerStatus = document.getElementById('player-status');
        const playerPlayPauseBtn = document.getElementById('player-play-pause-btn');
        const playerStopBtn = document.getElementById('player-stop-btn');
        const playerNextBtn = document.getElementById('player-next-btn');
        const playerPrevBtn = document.getElementById('player-prev-btn');
        let currentAudio = null;
        let currentPlayingAyahElement = null;
        let currentPlaylist = [];
        let currentTrackIndex = -1;



        const showLoading = () => loadingSpinner.classList.remove('hidden');
        const hideLoading = () => loadingSpinner.classList.add('hidden');
        const showApiError = () => apiErrorMessage.classList.remove('hidden');
        const hideApiError = () => apiErrorMessage.classList.add('hidden');

        // --- IndexedDB Initialization ---
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
                console.error("Database error:", event.target.errorCode);
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains('bookmarks')) {
                    const objectStore = db.createObjectStore('bookmarks', { keyPath: 'id' });
                    objectStore.createIndex('surah_ayah', ['surahNumber', 'ayahNumber'], { unique: true });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("Database initialized successfully");
            };
        }

        // --- API Source Selection ---
        document.querySelectorAll('.api-source').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update UI
                document.querySelectorAll('.api-source').forEach(b => {
                    b.classList.remove('bg-amber-500', 'text-emerald-900');
                    b.classList.add('bg-emerald-700', 'text-white');
                });
                btn.classList.remove('bg-emerald-700', 'text-white');
                btn.classList.add('bg-amber-500', 'text-emerald-900');
                
                // Update API source
                currentApiSource = btn.dataset.source;
                
                // Reload data
                fetchSurahList();
            });
        });

        retryApiBtn.addEventListener('click', () => {
            fetchSurahList();
        });

        // --- Navigation Logic ---
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.dataset.target;
                
                contentSections.forEach(section => {
                    section.classList.add('hidden');
                });
                
                navItems.forEach(nav => nav.classList.remove('active'));

                const targetSection = document.getElementById(`${targetId}-section`);
                targetSection.classList.remove('hidden');
                item.classList.add('active');

                // Initialize map only when the section is shown for the first time
                if (targetId === 'masjid' && !isMapInitialized) {
                    initMap();
                    isMapInitialized = true;
                    checkLocationPermission();
                }

                // Initialize hijaiyah when the section is shown
                if (targetId === 'hijaiyah' && !hijaiyahInitialized) {
                    initializeHijaiyah();
                    hijaiyahInitialized = true;
                }

                // Load data for new sections when they're opened
                if (targetId === 'doa' && !doaListContainer.children.length) {
                    loadDoaCategories();
                }

                if (targetId === 'bookmark') {
                    loadBookmarks();
                }

                if (targetId === 'hijriah') {
                    // Initialize with current month if not already loaded
                    if (!document.getElementById('hijri-calendar-grid').hasChildNodes()) {
                        renderHijriCalendar(new Date().getFullYear(), new Date().getMonth() + 1);
                    }
                }
            });
        });

        // --- Tajwid Coloring Functions ---
        function applyTajwidColoring(arabicText) {
            if (!tajwidEnabled) return arabicText;
            
            // This is a simplified tajwid coloring implementation
            // In a real application, you would use a more sophisticated algorithm or API
            let coloredText = arabicText;
            
            // Apply ghunnah coloring (ŸÜ and ŸÖ with shaddah)
            coloredText = coloredText.replace(/(ŸÜŸë|ŸÖŸë)/g, '<span class="tajwid-ghunnah">$1</span>');
            
            // Apply qalqalah coloring (ŸÇ ÿ∑ ÿ® ÿ¨ ÿØ)
            coloredText = coloredText.replace(/([ŸÇÿ∑ÿ®ÿ¨ÿØ])/g, '<span class="tajwid-qalqalah">$1</span>');
            
            // Apply madd coloring (ÿß Ÿà Ÿä with madd)
            coloredText = coloredText.replace(/([ÿßŸàŸä])/g, '<span class="tajwid-madd">$1</span>');
            
            // Apply ikhfa coloring (ŸÜ with letters other than ŸÖ Ÿà Ÿä ŸÜ ÿ± ŸÑ)
            coloredText = coloredText.replace(/ŸÜ([ÿ´ÿ∞ÿ±ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ŸÅÿÆÿ≠ÿπÿ∫ŸÇŸÉ])/g, 'ŸÜ<span class="tajwid-ikhfa">$1</span>');
            
            // Apply idgham coloring (ŸÜ with ŸÖ Ÿà Ÿä ŸÜ ÿ± ŸÑ)
            coloredText = coloredText.replace(/ŸÜ([ŸÖŸàŸÜÿ±ŸÑ])/g, 'ŸÜ<span class="tajwid-idgham">$1</span>');
            
            // Apply iqlab coloring (ŸÜ with ÿ®)
            coloredText = coloredText.replace(/ŸÜ(ÿ®)/g, 'ŸÜ<span class="tajwid-iqlab">$1</span>');
            
            // Apply hamzah coloring
            coloredText = coloredText.replace(/(ÿ£|ÿ•|ÿ§|ÿ¶)/g, '<span class="tajwid-hamzah">$1</span>');
            
            return coloredText;
        }

        function createTajwidControls() {
            return `
                <div class="tajwid-container">
                    <button class="tajwid-toggle" id="tajwid-toggle-btn">
                        ${tajwidEnabled ? 'Sembunyikan' : 'Tampilkan'} Tajwid Berwarna
                    </button>
                    <div class="tajwid-legend" id="tajwid-legend" style="${tajwidEnabled ? '' : 'display: none;'}">
                        <div class="tajwid-legend-item">
                            <div class="tajwid-legend-color tajwid-ghunnah"></div>
                            <span>Ghunnah</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-legend-color tajwid-qalqalah"></div>
                            <span>Qalqalah</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-legend-color tajwid-madd"></div>
                            <span>Madd</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-legend-color tajwid-ikhfa"></div>
                            <span>Ikhfa</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-legend-color tajwid-idgham"></div>
                            <span>Idgham</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-legend-color tajwid-iqlab"></div>
                            <span>Iqlab</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-legend-color tajwid-hamzah"></div>
                            <span>Hamzah</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Al-Quran Logic dengan multiple API ---
        const surahListView = document.getElementById('surah-list-view');
        const surahDetailView = document.getElementById('surah-detail-view');
        const surahListContainer = document.getElementById('surah-list');
        const surahDetailContainer = document.getElementById('surah-detail-content');
        const backToSurahListBtn = document.getElementById('back-to-surah-list');
        const tafsirModal = document.getElementById('tafsir-modal');
        const closeTafsirModalBtn = document.getElementById('close-tafsir-modal');

        async function fetchSurahList() {
            showLoading();
            hideApiError();
            surahListContainer.innerHTML = '<p class="text-center text-gray-400">Memuat data...</p>';
            
            try {
                let response;
                let data;
                
                if (currentApiSource === 'alquran-cloud') {
                    // Try primary API first
                    try {
                        response = await fetch('https://alquran.cloud/api/surah');
                        if (!response.ok) throw new Error('Network response was not ok');
                        data = await response.json();
                        allQuranData = data.data;
                        renderSurahList(data.data);
                    } catch (error) {
                        console.error('Primary API failed:', error);
                        // Try fallback API
                        response = await fetch('https://api.alquran.cloud/v1/surah');
                        if (!response.ok) throw new Error('Fallback API also failed');
                        data = await response.json();
                        allQuranData = data.data;
                        renderSurahList(data.data);
                    }
                } else {
                    // Use Santrikoding API
                    response = await fetch('https://quran-api.santrikoding.com/api/surah');
                    if (!response.ok) throw new Error('Network response was not ok');
                    data = await response.json();
                    allQuranData = data;
                    renderSurahList(data);
                }
            } catch (error) {
                console.error('All APIs failed:', error);
                surahListContainer.innerHTML = `<p class="text-red-400">Gagal memuat daftar surah: ${error.message}</p>`;
                showApiError();
            } finally {
                hideLoading();
            }
        }

        function renderSurahList(surahs) {
            surahListContainer.innerHTML = '';
            
            if (!surahs || surahs.length === 0) {
                surahListContainer.innerHTML = '<p class="text-center text-gray-400">Tidak ada data surah yang tersedia.</p>';
                return;
            }
            
            surahs.forEach(surah => {
                const card = document.createElement('div');
                card.className = 'bg-emerald-800 bg-opacity-50 p-4 rounded-lg cursor-pointer hover:bg-emerald-700 transition-all duration-300 transform hover:-translate-y-1';
                
                // Handle different data structures from different APIs
                const number = surah.number || surah.nomor;
                const name = surah.name || surah.nama;
                const englishName = surah.englishName || surah.nama_latin;
                const englishNameTranslation = surah.englishNameTranslation || surah.arti;
                const numberOfAyahs = surah.numberOfAyahs || surah.jumlah_ayat;
                
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <span class="bg-amber-500 text-emerald-900 w-8 h-8 flex items-center justify-center rounded-full font-bold mr-4">${number}</span>
                            <div>
                                <h3 class="font-bold text-lg text-amber-300">${englishName}</h3>
                                <p class="text-sm text-gray-300">${englishNameTranslation}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-amiri text-2xl text-amber-200">${name}</p>
                            <p class="text-xs text-gray-400">${numberOfAyahs} ayat</p>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => fetchSurahDetail(number));
                surahListContainer.appendChild(card);
            });
        }

        async function fetchSurahDetail(surahNumber) {
            showLoading();
            try {
                let response, data, arabicData;
                
                if (currentApiSource === 'alquran-cloud') {
                    // Try primary API first
                    try {
                        response = await fetch(`https://alquran.cloud/api/surah/${surahNumber}/id.indonesian`);
                        if (!response.ok) throw new Error('Network response was not ok');
                        data = await response.json();
                        
                        // Also get Arabic text
                        const arabicResponse = await fetch(`https://alquran.cloud/api/surah/${surahNumber}`);
                        arabicData = await arabicResponse.json();
                        
                        renderSurahDetail(data.data, arabicData.data);
                    } catch (error) {
                        console.error('Primary API failed:', error);
                        // Try fallback API
                        response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/id.indonesian`);
                        if (!response.ok) throw new Error('Fallback API also failed');
                        data = await response.json();
                        
                        // Also get Arabic text
                        const arabicResponse = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}`);
                        arabicData = await arabicResponse.json();
                        
                        renderSurahDetail(data.data, arabicData.data);
                    }
                } else {
                    // Use Santrikoding API
                    response = await fetch(`https://quran-api.santrikoding.com/api/surah/${surahNumber}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    data = await response.json();
                    
                    renderSurahDetail(data, null);
                }
                
                surahListView.classList.add('hidden');
                surahDetailView.classList.remove('hidden');
                window.scrollTo(0, 0);
            } catch (error) {
                surahDetailContainer.innerHTML = `<p class="text-red-400">Gagal memuat detail surah: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        function renderSurahDetail(surah, arabicSurah) {
            let ayahsHtml;
            
            if (currentApiSource === 'alquran-cloud') {
                // Render using alquran.cloud data structure
                ayahsHtml = surah.ayahs.map((ayat, index) => {
                    const arabicAyah = arabicSurah.ayahs[index];
                    const coloredArabicText = applyTajwidColoring(arabicAyah.text);
                    
                    return `
                        <div class="ayah-container border-b-2 border-amber-500 border-opacity-30 py-6" id="ayah-${surah.number}-${ayat.numberInSurah}">
                            <div class="flex justify-between items-center mb-4">
                                <span class="bg-amber-500 text-emerald-900 font-bold px-3 py-1 rounded-md">${surah.number}:${ayat.numberInSurah}</span>
                                <div>
                                    <button class="bookmark-btn px-3 py-1 bg-emerald-600 hover:bg-emerald-500 rounded-md text-sm" data-surah-number="${surah.number}" data-ayah-number="${ayat.numberInSurah}" data-surah-name="${surah.englishName}" data-ayah-text="${arabicAyah.text}" data-translation="${ayat.text}">üîñ</button>
                                    <button class="tafsir-btn px-3 py-1 bg-emerald-600 hover:bg-emerald-500 rounded-md text-sm" data-surah="${surah.number}" data-ayat="${ayat.numberInSurah}">Tafsir</button>
                                </div>
                            </div>
                            <p class="font-amiri text-3xl text-right leading-loose text-amber-100 mb-4">${coloredArabicText}</p>
                            <p class="text-gray-300 leading-relaxed">${ayat.text}</p>
                            <div class="audio-player mt-4 flex items-center gap-4">
                                <button class="play-button" data-surah="${surah.number}" data-ayah="${ayat.numberInSurah}" data-total-ayah="${surah.numberOfAyahs}">‚ñ∂</button>
                                <button class="stop-button hidden px-3 py-1 bg-red-600 text-white rounded-md text-sm">‚ñ† Stop</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                surahDetailContainer.innerHTML = `
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-amber-400 mb-2">${surah.englishName}</h2>
                        <p class="font-amiri text-3xl text-amber-200 mb-2">${surah.name}</p>
                        <p class="text-gray-300 mb-4">${surah.englishNameTranslation} (${surah.numberOfAyahs} ayat)</p>
                        ${createTajwidControls()}
                    </div>
                    <div class="space-y-4">
                        ${ayahsHtml}
                    </div>
                `;
            } else {
                // Render using Santrikoding API data structure
                ayahsHtml = surah.ayat.map(ayat => {
                    const coloredArabicText = applyTajwidColoring(ayat.ar);
                    
                    return `
                        <div class="ayah-container border-b-2 border-amber-500 border-opacity-30 py-6" id="ayah-${surah.nomor}-${ayat.nomor}">
                            <div class="flex justify-between items-center mb-4">
                                <span class="bg-amber-500 text-emerald-900 font-bold px-3 py-1 rounded-md">${surah.nomor}:${ayat.nomor}</span>
                                <div>
                                    <button class="bookmark-btn px-3 py-1 bg-emerald-600 hover:bg-emerald-500 rounded-md text-sm" data-surah-number="${surah.nomor}" data-ayah-number="${ayat.nomor}" data-surah-name="${surah.nama_latin}" data-ayah-text="${ayat.ar}" data-translation="${ayat.idn}">üîñ</button>
                                    <button class="tafsir-btn px-3 py-1 bg-emerald-600 hover:bg-emerald-500 rounded-md text-sm" data-surah="${surah.nomor}" data-ayat="${ayat.nomor}">Tafsir</button>
                                </div>
                            </div>
                            <p class="font-amiri text-3xl text-right leading-loose text-amber-100 mb-4">${coloredArabicText}</p>
                            <p class="text-gray-300 leading-relaxed">${ayat.idn}</p>
                            <div class="audio-player mt-4 flex items-center gap-4">
                                <button class="play-button" data-surah="${surah.nomor}" data-ayah="${ayat.nomor}" data-total-ayah="${surah.jumlah_ayat}">‚ñ∂</button>
                                <button class="stop-button hidden px-3 py-1 bg-red-600 text-white rounded-md text-sm">‚ñ† Stop</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                surahDetailContainer.innerHTML = `
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-amber-400 mb-2">${surah.nama_latin}</h2>
                        <p class="font-amiri text-3xl text-amber-200 mb-2">${surah.nama}</p>
                        <p class="text-gray-300 mb-4">${surah.arti} (${surah.jumlah_ayat} ayat)</p>
                        ${createTajwidControls()}
                    </div>
                    <div class="space-y-4">
                        ${ayahsHtml}
                    </div>
                `;
            }
            
            // Add event listeners for tafsir buttons
            document.querySelectorAll('.tafsir-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const surahNumber = btn.dataset.surah;
                    const ayatNumber = btn.dataset.ayat;
                    fetchTafsir(surahNumber, ayatNumber);
                });
            });
            
            // Add event listeners for bookmark buttons
            document.querySelectorAll('.bookmark-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    toggleBookmark(e.currentTarget.dataset);
                });
            });

            // Add event listeners for audio buttons
            document.querySelectorAll('.play-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    playAudio(btn.dataset.surah, btn.dataset.ayah, btn.dataset.totalAyah);
                    startPlaybackFrom(btn.dataset.surah, btn.dataset.ayah);
                });
            });

            document.querySelectorAll('.stop-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    stopAudio();
                });
            });

            
            // Add event listener for tajwid toggle
            const tajwidToggleBtn = document.getElementById('tajwid-toggle-btn');
            if (tajwidToggleBtn) {
                tajwidToggleBtn.addEventListener('click', () => {
                    tajwidEnabled = !tajwidEnabled;
                    fetchSurahDetail(surah.number || surah.nomor);
                });
            }
        }

        async function fetchTafsir(surahNumber, ayatNumber) {
            showLoading();
            try {
                // Get verse text and translation
                const response = await fetch(`https://api.quran.com/api/v4/quran/verses/by_key/${surahNumber}:${ayatNumber}?language=id&words=false`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                // Get tafsir text (using Kemenag tafsir, ID 169)
                const tafsirResponse = await fetch(`https://api.quran.com/api/v4/quran/tafsirs/169?verse_key=${surahNumber}:${ayatNumber}`);
                let tafsirData = null;
                let tafsirText = "Tafsir tidak tersedia untuk ayat ini.";
                
                if (tafsirResponse.ok) {
                    tafsirData = await tafsirResponse.json();
                    if (tafsirData.tafsirs && tafsirData.tafsirs.length > 0) {
                        tafsirText = tafsirData.tafsirs[0].text;
                    }
                }
                showTafsirModal(surahNumber, ayatNumber, data.verse, tafsirText);
            } catch (error) {
                console.error('Error fetching tafsir:', error);
                showTafsirModal(surahNumber, ayatNumber, null, "Gagal memuat tafsir. Silakan coba lagi.");
            } finally {
                hideLoading();
            }
        }

        function showTafsirModal(surahNumber, ayatNumber, verse, tafsirText) {
            const modalTitle = document.getElementById('tafsir-modal-title');
            const modalContent = document.getElementById('tafsir-modal-content');
            
            modalTitle.textContent = `Tafsir QS ${surahNumber}:${ayatNumber}`;
            
            if (verse) {
                modalContent.innerHTML = `
                    <div class="mb-4">
                        <p class="font-amiri text-2xl text-right text-amber-100 mb-2">${verse.text_uthmani}</p>
                        <p class="text-gray-300"><em>${verse.translations[0].text}</em></p>
                    </div>
                    <div class="border-t border-emerald-700 pt-4">
                        <h3 class="text-lg font-semibold text-amber-300 mb-2">Tafsir:</h3>
                        <div class="text-gray-200 leading-relaxed prose prose-invert max-w-none">${tafsirText}</div>
                    </div>
                `;
            } else {
                modalContent.innerHTML = `
                    <div class="border-t border-emerald-700 pt-4">
                        <h3 class="text-lg font-semibold text-amber-300 mb-2">Tafsir:</h3>
                        <p class="text-gray-200 leading-relaxed">${tafsirText}</p>
                    </div>
                `;
            }
            
            tafsirModal.classList.remove('hidden');
        }

        function playAudio(surahNumber, ayahNumber, totalAyahs) {
            stopAudio(); // Stop any currently playing audio
        // --- Global Murottal Player Logic ---
        function startPlaybackFrom(surahNumber, startAyahNumber) {
            const surahData = allQuranData.find(s => (s.number || s.nomor) == surahNumber);
            if (!surahData) return;

            const totalAyahs = surahData.numberOfAyahs || surahData.jumlah_ayat;
            currentPlaylist = [];
            for (let i = 1; i <= totalAyahs; i++) {
                currentPlaylist.push({
                    surahNumber: surahNumber,
                    ayahNumber: i,
                    surahName: surahData.englishName || surahData.nama_latin
                });
            }

            currentTrackIndex = startAyahNumber - 1;
            playCurrentTrack();
            globalPlayer.classList.remove('hidden');
            setTimeout(() => globalPlayer.classList.remove('translate-y-full'), 10); // Animate in
        }

        function playCurrentTrack() {
            if (currentTrackIndex < 0 || currentTrackIndex >= currentPlaylist.length) {
                stopAudio();
                return;
            }

            const track = currentPlaylist[currentTrackIndex];
            const { surahNumber, ayahNumber, surahName } = track;

            // Stop previous audio if any
            if (currentAudio) {
                currentAudio.pause();
            }

            // Highlight new verse
            if (currentPlayingAyahElement) {
                currentPlayingAyahElement.classList.remove('bg-emerald-700', 'rounded-lg');
            }
            const ayahId = `ayah-${surahNumber}-${ayahNumber}`;
            currentPlayingAyahElement = document.getElementById(ayahId);
            if (currentPlayingAyahElement) {
                currentPlayingAyahElement.classList.add('bg-emerald-700', 'rounded-lg');
                currentPlayingAyahElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            if (!currentPlayingAyahElement) return;
            // Update global player UI
            playerInfo.textContent = `QS. ${surahName} [${surahNumber}:${ayahNumber}]`;
            playerStatus.textContent = 'Memutar...';
            playerPlayPauseBtn.textContent = '‚è∏Ô∏è';

            // Highlight the current verse
            currentPlayingAyahElement.classList.add('bg-emerald-700', 'rounded-lg');
            currentPlayingAyahElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Show stop button
            const stopButton = currentPlayingAyahElement.querySelector('.stop-button');
            if (stopButton) stopButton.classList.remove('hidden');

            const audioUrl = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${surahNumber * 1000 + parseInt(ayahNumber)}.mp3`;
            const audioUrl = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${parseInt(surahNumber) * 1000 + parseInt(ayahNumber)}.mp3`;
            currentAudio = new Audio(audioUrl);

            currentAudio.play().catch(error => {
                console.error('Error playing audio:', error);
                alert('Gagal memutar audio. Silakan coba lagi.');
                stopAudio(); // Clean up on error
                playerStatus.textContent = 'Gagal memutar';
            });

            // Event listener for when the audio ends
            currentAudio.onended = () => {
                const nextAyahNumber = parseInt(ayahNumber) + 1;
                if (nextAyahNumber <= totalAyahs) {
                    playAudio(surahNumber, nextAyahNumber, totalAyahs);
                playNext();
            };

            currentAudio.onpause = () => {
                playerStatus.textContent = 'Dijeda';
                playerPlayPauseBtn.textContent = '‚ñ∂Ô∏è';
            };

            currentAudio.onplay = () => {
                playerStatus.textContent = 'Memutar...';
                playerPlayPauseBtn.textContent = '‚è∏Ô∏è';
            };
        }

        function playNext() {
            if (currentTrackIndex < currentPlaylist.length - 1) {
                currentTrackIndex++;
                playCurrentTrack();
            } else {
                stopAudio(); // End of playlist
            }
        }

        function playPrev() {
            if (currentTrackIndex > 0) {
                currentTrackIndex--;
                playCurrentTrack();
            }
        }

        function togglePlayPause() {
            if (currentAudio) {
                if (currentAudio.paused) {
                    currentAudio.play();
                } else {
                    stopAudio(); // End of surah
                    currentAudio.pause();
                }
            };
            }
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            document.querySelectorAll('.ayah-container').forEach(el => el.classList.remove('bg-emerald-700', 'rounded-lg'));
            document.querySelectorAll('.stop-button').forEach(btn => btn.classList.add('hidden'));
            if (currentPlayingAyahElement) {
                currentPlayingAyahElement.classList.remove('bg-emerald-700', 'rounded-lg');
                currentPlayingAyahElement = null;
            }
            currentPlaylist = [];
            currentTrackIndex = -1;
            globalPlayer.classList.add('translate-y-full');
            setTimeout(() => globalPlayer.classList.add('hidden'), 300);
        }

        playerPlayPauseBtn.addEventListener('click', togglePlayPause);
        playerStopBtn.addEventListener('click', stopAudio);
        playerNextBtn.addEventListener('click', playNext);
        playerPrevBtn.addEventListener('click', playPrev);


        backToSurahListBtn.addEventListener('click', () => {
            surahListView.classList.remove('hidden');
            surahDetailView.classList.add('hidden');
        });

        closeTafsirModalBtn.addEventListener('click', () => {
            tafsirModal.classList.add('hidden');
        });

        // --- Hadits Logic ---
        const haditsPerawi = document.getElementById('hadits-perawi');
        const haditsStart = document.getElementById('hadits-start');
        const searchHaditsBtn = document.getElementById('search-hadits-btn');
        const haditsResult = document.getElementById('hadits-result');

        searchHaditsBtn.addEventListener('click', () => {
            const perawi = haditsPerawi.value;
            const number = haditsStart.value;
            
            if (!perawi) {
                haditsResult.innerHTML = '<p class="text-red-400">Silakan pilih perawi hadits.</p>';
                return;
            }
            if (!number || number <= 0) {
                haditsResult.innerHTML = '<p class="text-red-400">Silakan masukkan nomor hadits yang valid.</p>';
                return;
            }
            
            fetchHadits(perawi, number);
        });

        async function fetchHadits(perawi, number) {
            showLoading();
            haditsResult.innerHTML = '<p class="text-center text-gray-400">Memuat data...</p>';
            
            try {
                // Using a more stable API source
                const response = await fetch(`https://api.hadith.gading.dev/books/${perawi}/${number}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Hadits nomor ${number} tidak ditemukan untuk perawi ${perawi}.`);
                    }
                    throw new Error('Gagal mengambil data hadits dari server.');
                }
                const data = await response.json();
                
                if (!data.data || !data.data.contents) {
                    haditsResult.innerHTML = '<p class="text-center text-gray-400">Tidak ada hadits ditemukan.</p>';
                    return;
                }
                
                renderHadits(data.data.contents, data.data.name);
            } catch (error) {
                console.error('Error fetching hadits:', error);
                haditsResult.innerHTML = `<p class="text-red-400">Gagal memuat hadits: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        function renderHadits(haditsItem, perawiName) {
            haditsResult.innerHTML = '';
            const card = document.createElement('div');
            card.className = 'bg-emerald-800 bg-opacity-50 p-4 rounded-lg';
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-lg text-amber-300">${perawiName} No. ${haditsItem.number}</h3>
                </div>
                <p class="font-amiri text-xl text-right leading-loose text-amber-100 mb-3">${haditsItem.arab}</p>
                <p class="text-gray-300 leading-relaxed">${haditsItem.id}</p>
            `;
            
            haditsResult.appendChild(card);
        }

        // --- Jadwal Sholat Logic ---
        const sholatCity = document.getElementById('sholat-city');
        const searchSholatBtn = document.getElementById('search-sholat-btn');
        const sholatResult = document.getElementById('sholat-result');

        searchSholatBtn.addEventListener('click', () => {
            const city = sholatCity.value.trim();
            
            if (!city) {
                sholatResult.innerHTML = '<p class="text-red-400">Silakan masukkan nama kota.</p>';
                return;
            }
            
            fetchSholatSchedule(city);
        });

        async function fetchSholatSchedule(city) {
            showLoading();
            sholatResult.innerHTML = '<p class="text-center text-gray-400">Memuat jadwal sholat...</p>';
            
            try {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;
                
                // 1. Find city ID from API
                const citySearchResponse = await fetch(`https://api.myquran.com/v1/sholat/kota/cari/${city}`);
                if (!citySearchResponse.ok) throw new Error('Gagal mencari kota.');
                const citySearchData = await citySearchResponse.json();

                if (!citySearchData.status || citySearchData.data.length === 0) {
                    sholatResult.innerHTML = `<p class="text-red-400">Kota "${city}" tidak ditemukan.</p>`;
                    return;
                }

                const cityId = citySearchData.data[0].id;
                const cityName = citySearchData.data[0].lokasi;

                // 2. Get prayer schedule using city ID for the current month
                const response = await fetch(`https://api.myquran.com/v1/sholat/jadwal/${cityId}/${year}/${month}`);
                if (!response.ok) throw new Error('Gagal mengambil jadwal sholat.');
                const data = await response.json();

                if (!data.status || !data.data.jadwal) {
                    throw new Error('Data jadwal sholat tidak valid.');
                }

                // Find today's schedule
                const todaySchedule = data.data.jadwal.find(j => j.tanggal === today.toISOString().split('T')[0]);
                
                if (todaySchedule) {
                    renderSholatSchedule(todaySchedule, cityName);
                } else {
                    throw new Error("Jadwal untuk hari ini tidak ditemukan.");
                }
            } catch (error) {
                console.error('Error fetching prayer times:', error);
                sholatResult.innerHTML = `<p class="text-red-400">Gagal memuat jadwal sholat: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        function renderSholatSchedule(schedule, cityName) {
            sholatResult.innerHTML = `
                <div class="bg-emerald-800 bg-opacity-50 p-4 rounded-lg">
                    <h3 class="text-xl font-bold text-amber-300 mb-4">Jadwal Sholat untuk ${cityName}</h3>
                    <p class="text-gray-300 mb-4">Tanggal: ${schedule.tanggal}</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="bg-emerald-700 p-3 rounded-lg text-center">
                            <p class="text-gray-300 text-sm">Subuh</p>
                            <p class="text-xl font-bold text-amber-300">${schedule.subuh}</p>
                        </div>
                        <div class="bg-emerald-700 p-3 rounded-lg text-center">
                            <p class="text-gray-300 text-sm">Dzuhur</p>
                            <p class="text-xl font-bold text-amber-300">${schedule.dzuhur}</p>
                        </div>
                        <div class="bg-emerald-700 p-3 rounded-lg text-center">
                            <p class="text-gray-300 text-sm">Ashar</p>
                            <p class="text-xl font-bold text-amber-300">${schedule.ashar}</p>
                        </div>
                        <div class="bg-emerald-700 p-3 rounded-lg text-center">
                            <p class="text-gray-300 text-sm">Maghrib</p>
                            <p class="text-xl font-bold text-amber-300">${schedule.maghrib}</p>
                        </div>
                        <div class="bg-emerald-700 p-3 rounded-lg text-center">
                            <p class="text-gray-300 text-sm">Isya</p>
                            <p class="text-xl font-bold text-amber-300">${schedule.isya}</p>
                        </div>
                        <div class="bg-emerald-700 p-3 rounded-lg text-center">
                            <p class="text-gray-300 text-sm">Imsak</p>
                            <p class="text-xl font-bold text-amber-300">${schedule.imsak}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Arah Kiblat Logic ---
        const startQiblaBtn = document.getElementById('start-qibla-btn');
        const compassNeedle = document.getElementById('compass-needle');
        const qiblaInfo = document.getElementById('qibla-info');
        const qiblaInstruction = document.getElementById('qibla-instruction');

        startQiblaBtn.addEventListener('click', () => {
            if (window.DeviceOrientationEvent) {
                // Request permission for iOS 13+
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                startCompass();
                            } else {
                                qiblaInfo.textContent = 'Izin akses sensor ditolak. Tidak dapat menentukan arah kiblat.';
                            }
                        })
                        .catch(error => {
                            console.error('Error requesting device orientation permission:', error);
                            qiblaInfo.textContent = 'Terjadi kesalahan saat meminta izin akses sensor.';
                        });
                } else {
                    // Non-iOS 13+ devices
                    startCompass();
                }
            } else {
                qiblaInfo.textContent = 'Perangkat Anda tidak mendukung sensor orientasi. Tidak dapat menentukan arah kiblat.';
            }
        });

        function startCompass() {
            qiblaInstruction.textContent = 'Mendeteksi arah kiblat...';
            startQiblaBtn.textContent = 'Mendeteksi...';
            startQiblaBtn.disabled = true;
            
            // Get user's current position
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude } = position.coords;
                    
                    // Calculate Qibla direction
                    const qiblaDirection = calculateQiblaDirection(latitude, longitude);
                    
                    // Start watching device orientation
                    window.addEventListener('deviceorientation', handleOrientation);
                    
                    qiblaInstruction.textContent = 'Arahkan bagian atas ponsel Anda ke arah panah.';
                    qiblaInfo.textContent = `Arah Kiblat: ${qiblaDirection.toFixed(1)}¬∞`;
                },
                error => {
                    console.error('Error getting location:', error);
                    qiblaInfo.textContent = 'Gagal mendapatkan lokasi. Pastikan GPS aktif dan berikan izin lokasi.';
                    startQiblaBtn.textContent = 'Mulai Deteksi Kiblat';
                    startQiblaBtn.disabled = false;
                }
            );
        }

        function handleOrientation(event) {
            const alpha = event.alpha; // Compass direction (0-360)
            
            if (alpha !== null) {
                // Get user's current position
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        
                        // Calculate Qibla direction
                        const qiblaDirection = calculateQiblaDirection(latitude, longitude);
                        
                        // Calculate the difference between current direction and Qibla
                        const difference = qiblaDirection - alpha;
                        
                        // Rotate the compass needle
                        compassNeedle.style.transform = `rotate(${difference}deg)`;
                    },
                    error => {
                        console.error('Error getting location:', error);
                    }
                );
            }
        }

        function calculateQiblaDirection(latitude, longitude) {
            // Kaaba coordinates
            const kaabaLatitude = 21.4225;
            const kaabaLongitude = 39.8262;
            
            // Convert to radians
            const lat1 = latitude * (Math.PI / 180);
            const lat2 = kaabaLatitude * (Math.PI / 180);
            const longDiff = (kaabaLongitude - longitude) * (Math.PI / 180);
            
            // Calculate Qibla direction
            const y = Math.sin(longDiff);
            const x = Math.cos(lat1) * Math.tan(lat2) - Math.sin(lat1) * Math.cos(longDiff);
            
            let direction = Math.atan2(y, x) * (180 / Math.PI);
            
            // Normalize to 0-360
            direction = (direction + 360) % 360;
            
            return direction;
        }

        // --- Masjid Finder Logic ---
        function initMap() {
            // Initialize the map
            map = L.map('map').setView([-6.2088, 106.8456], 13); // Default to Jakarta
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function checkLocationPermission() {
            if (navigator.geolocation) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then(result => {
                        if (result.state === 'granted') {
                            locationPermissionDiv.classList.add('hidden');
                        } else if (result.state === 'prompt') {
                            locationPermissionDiv.classList.remove('hidden');
                        } else if (result.state === 'denied') {
                            locationPermissionDiv.classList.remove('hidden');
                            locationPermissionDiv.innerHTML = `
                                <p class="text-amber-300">Izin lokasi ditolak. Aplikasi membutuhkan izin lokasi untuk menemukan masjid terdekat. Silakan ubah pengaturan izin lokasi pada browser Anda.</p>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error checking location permission:', error);
                        locationPermissionDiv.classList.remove('hidden');
                    });
            } else {
                locationPermissionDiv.classList.remove('hidden');
                locationPermissionDiv.innerHTML = `
                    <p class="text-amber-300">Browser Anda tidak mendukung geolokasi. Aplikasi tidak dapat menemukan masjid terdekat.</p>
                `;
            }
        }

        requestLocationBtn.addEventListener('click', () => {
            navigator.geolocation.getCurrentPosition(
                position => {
                    locationPermissionDiv.classList.add('hidden');
                },
                error => {
                    console.error('Error getting location:', error);
                    locationPermissionDiv.innerHTML = `
                        <p class="text-amber-300">Gagal mendapatkan izin lokasi. Aplikasi membutuhkan izin lokasi untuk menemukan masjid terdekat.</p>
                        <button class="permission-button" id="request-location-btn">Coba Lagi</button>
                    `;
                    
                    // Re-attach event listener
                    document.getElementById('request-location-btn').addEventListener('click', () => {
                        location.reload();
                    });
                }
            );
        });

        findMosquesBtn.addEventListener('click', findNearbyMosques);

        async function findNearbyMosques() {
            showLoading();
            
            try {
                // Mendapatkan posisi pengguna
                const position = await getCurrentPosition();
                const { latitude, longitude } = position.coords;
                
                // Inisialisasi peta jika belum ada
                if (!map) {
                    initMap();
                }
                
                // Set posisi pengguna di peta
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                
                userMarker = L.marker([latitude, longitude], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div class="bg-blue-500 w-4 h-4 rounded-full border-2 border-white"></div>',
                        iconSize: [16, 16]
                    })
                }).addTo(map);
                
                map.setView([latitude, longitude], 15);
                
                // Hapus marker masjid lama
                mosqueMarkers.forEach(marker => map.removeLayer(marker));
                mosqueMarkers = [];
                
                // Hapus rute lama
                if (routingControl) {
                    map.removeControl(routingControl);
                }
                
                // Get search parameters
                const radiusSelect = document.getElementById('search-radius');
                const maxResultsSelect = document.getElementById('max-results');
                const radius = parseInt(radiusSelect.value); // in meters
                const maxResults = parseInt(maxResultsSelect.value);
                
                // Menggunakan Overpass API untuk mencari masjid dalam radius yang dipilih
                const overpassQuery = `
                    [out:json][timeout:25];
                    (
                        node["amenity"="place_of_worship"]["religion"="muslim"](around:${radius},${latitude},${longitude});
                        way["amenity"="place_of_worship"]["religion"="muslim"](around:${radius},${latitude},${longitude});
                        relation["amenity"="place_of_worship"]["religion"="muslim"](around:${radius},${latitude},${longitude});
                    );
                    out geom;
                `;
                
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`);
                const data = await response.json();
                
                // Mengurutkan berdasarkan jarak dan mengambil masjid terdekat sesuai dengan maxResults
                const mosques = data.elements
                    .filter(element => element.tags && element.tags.name)
                    .map(element => {
                        let lat, lng;
                        
                        if (element.type === 'node') {
                            lat = element.lat;
                            lng = element.lon;
                        } else if (element.type === 'way') {
                            // Untuk way, gunakan pusat dari geometri
                            const coords = element.geometry || [];
                            if (coords.length > 0) {
                                lat = coords.reduce((sum, coord) => sum + coord.lat, 0) / coords.length;
                                lng = coords.reduce((sum, coord) => sum + coord.lon, 0) / coords.length;
                            }
                        } else if (element.type === 'relation') {
                            // Untuk relation, gunakan pusat dari member
                            const members = element.members || [];
                            if (members.length > 0) {
                                lat = members.reduce((sum, member) => sum + (member.lat || 0), 0) / members.length;
                                lng = members.reduce((sum, member) => sum + (member.lon || 0), 0) / members.length;
                            }
                        }
                        
                        // Hitung jarak
                        const distance = calculateDistance(latitude, longitude, lat, lng);
                        
                        return {
                            id: element.id,
                            name: element.tags.name,
                            address: element.tags["addr:street"] || "Alamat tidak tersedia",
                            lat: lat,
                            lng: lng,
                            distance: distance
                        };
                    })
                    .filter(mosque => mosque.lat && mosque.lng) // Hanya masjid dengan koordinat valid
                    .sort((a, b) => a.distance - b.distance) // Urutkan berdasarkan jarak
                    .slice(0, maxResults); // Ambil masjid terdekat sesuai dengan maxResults
                
                // Tambahkan marker untuk setiap masjid
                mosques.forEach(mosque => {
                    const marker = L.marker([mosque.lat, mosque.lng], {
                        icon: L.divIcon({
                            className: 'mosque-marker',
                            html: '<div class="bg-amber-500 w-6 h-6 rounded-full border-2 border-white flex items-center justify-center"><span class="text-white text-xs">üïå</span></div>',
                            iconSize: [24, 24]
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`<b>${mosque.name}</b><br>${mosque.address}<br>Jarak: ${mosque.distance.toFixed(2)} km`);
                    
                    marker.on('click', () => {
                        // Update UI untuk menandai masjid yang dipilih
                        document.querySelectorAll('.mosque-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        const listItem = document.getElementById(`mosque-${mosque.id}`);
                        if (listItem) {
                            listItem.classList.add('active');
                            listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                        
                        // Buat rute dari lokasi pengguna ke masjid
                        if (routingControl) {
                            map.removeControl(routingControl);
                        }
                        
                        routingControl = L.Routing.control({
                            waypoints: [
                                L.latLng(latitude, longitude),
                                L.latLng(mosque.lat, mosque.lng)
                            ],
                            routeWhileDragging: true,
                            addWaypoints: false,
                            createMarker: function() { return null; }, // Gunakan marker yang sudah ada
                            lineOptions: {
                                styles: [{ color: '#f59e0b', weight: 4, opacity: 0.7 }]
                            }
                        }).addTo(map);
                    });
                    
                    mosqueMarkers.push(marker);
                });
                
                // Tampilkan daftar masjid
                renderMosqueList(mosques);
                
                // Jika tidak ada masjid ditemukan
                if (mosques.length === 0) {
                    mosqueListContainer.innerHTML = `<p class="text-center text-gray-400">Tidak ada masjid ditemukan dalam radius ${radius/1000} km. Coba cari dengan radius yang lebih besar.</p>`;
                }
                
            } catch (error) {
                console.error('Error finding mosques:', error);
                mosqueListContainer.innerHTML = `<p class="text-red-400">Gagal menemukan masjid: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject);
            });
        }

        // Fungsi untuk menghitung jarak antara dua koordinat (dalam km)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius bumi dalam km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c; // Jarak dalam km
            return distance;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // Fungsi untuk menampilkan daftar masjid
        function renderMosqueList(mosques) {
            mosqueListContainer.innerHTML = '';
            
            mosques.forEach(mosque => {
                const mosqueItem = document.createElement('div');
                mosqueItem.className = 'mosque-item';
                mosqueItem.id = `mosque-${mosque.id}`;
                
                mosqueItem.innerHTML = `
                    <div class="mosque-name">${mosque.name}</div>
                    <div class="mosque-address">${mosque.address}</div>
                    <div class="mosque-distance">Jarak: ${mosque.distance.toFixed(2)} km</div>
                `;
                
                mosqueItem.addEventListener('click', () => {
                    // Buka popup marker dan buat rute
                    const marker = mosqueMarkers.find(m => {
                        const position = m.getLatLng();
                        return Math.abs(position.lat - mosque.lat) < 0.0001 && Math.abs(position.lng - mosque.lng) < 0.0001;
                    });
                    
                    if (marker) {
                        marker.openPopup();
                        
                        // Update UI
                        document.querySelectorAll('.mosque-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        mosqueItem.classList.add('active');
                        
                        // Buat rute
                        if (userMarker && routingControl) {
                            map.removeControl(routingControl);
                        }
                        
                        if (userMarker) {
                            const userPosition = userMarker.getLatLng();
                            routingControl = L.Routing.control({
                                waypoints: [
                                    L.latLng(userPosition.lat, userPosition.lng),
                                    L.latLng(mosque.lat, mosque.lng)
                                ],
                                routeWhileDragging: true,
                                addWaypoints: false,
                                createMarker: function() { return null; },
                                lineOptions: {
                                    styles: [{ color: '#f59e0b', weight: 4, opacity: 0.7 }]
                                }
                            }).addTo(map);
                        }
                    }
                });
                
                mosqueListContainer.appendChild(mosqueItem);
            });
        }

        // --- Tasbih Logic ---
        const tasbihCount = document.getElementById('tasbih-count');
        const tasbihIncrementBtn = document.getElementById('tasbih-increment-btn');
        const tasbihResetBtn = document.getElementById('tasbih-reset-btn');
        
        let count = 0;
        
        tasbihIncrementBtn.addEventListener('click', () => {
            count++;
            tasbihCount.textContent = count;
            
            // Add haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            // Check if count reaches 33 or 100
            if (count === 33) {
                showNotification('33x - Subhanallah');
            } else if (count === 66) {
                showNotification('66x - Alhamdulillah');
            } else if (count === 99) {
                showNotification('99x - Allahu Akbar');
            } else if (count === 100) {
                showNotification('100x - Selesai! Reset untuk memulai lagi.');
            }
        });
        
        tasbihResetBtn.addEventListener('click', () => {
            count = 0;
            tasbihCount.textContent = count;
        });
        
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-amber-500 text-emerald-900 px-4 py-2 rounded-lg font-bold z-50';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 2 seconds
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 2000);
        }

        // --- Zakat Calculator Logic ---
        const calculateProfesiBtn = document.getElementById('calculate-profesi-btn');
        const calculateMaalBtn = document.getElementById('calculate-maal-btn');
        const calculateFitrahBtn = document.getElementById('calculate-fitrah-btn');
        
        calculateProfesiBtn.addEventListener('click', () => {
            const income = parseFloat(document.getElementById('zakat-profesi-income').value) || 0;
            const goldPrice = parseFloat(document.getElementById('zakat-profesi-gold-price').value) || 0;
            
            if (income <= 0 || goldPrice <= 0) {
                document.getElementById('zakat-profesi-result').innerHTML = '<p class="text-red-400">Silakan masukkan nilai yang valid.</p>';
                return;
            }
            
            // Calculate nisab (85 grams of gold)
            const nisab = 85 * goldPrice;
            
            if (income < nisab) {
                document.getElementById('zakat-profesi-result').innerHTML = `<p class="text-gray-300">Pendapatan Anda belum mencapai nisab (Rp ${nisab.toLocaleString('id-ID')}). Tidak wajib zakat.</p>`;
            } else {
                const zakatAmount = income * 0.025; // 2.5%
                document.getElementById('zakat-profesi-result').innerHTML = `<p class="text-amber-300">Zakat profesi: Rp ${zakatAmount.toLocaleString('id-ID')}</p>`;
            }
        });
        
        calculateMaalBtn.addEventListener('click', () => {
            const wealth = parseFloat(document.getElementById('zakat-maal-wealth').value) || 0;
            const goldPrice = 1300000; // Default gold price
            
            if (wealth <= 0) {
                document.getElementById('zakat-maal-result').innerHTML = '<p class="text-red-400">Silakan masukkan nilai yang valid.</p>';
                return;
            }
            
            // Calculate nisab (85 grams of gold)
            const nisab = 85 * goldPrice;
            
            if (wealth < nisab) {
                document.getElementById('zakat-maal-result').innerHTML = `<p class="text-gray-300">Harta Anda belum mencapai nisab (Rp ${nisab.toLocaleString('id-ID')}). Tidak wajib zakat.</p>`;
            } else {
                const zakatAmount = wealth * 0.025; // 2.5%
                document.getElementById('zakat-maal-result').innerHTML = `<p class="text-amber-300">Zakat maal: Rp ${zakatAmount.toLocaleString('id-ID')}</p>`;
            }
        });
        
        calculateFitrahBtn.addEventListener('click', () => {
            const people = parseInt(document.getElementById('zakat-fitrah-people').value) || 0;
            const ricePrice = parseFloat(document.getElementById('zakat-fitrah-rice-price').value) || 0;
            
            if (people <= 0 || ricePrice <= 0) {
                document.getElementById('zakat-fitrah-result').innerHTML = '<p class="text-red-400">Silakan masukkan nilai yang valid.</p>';
                return;
            }
            
            // Calculate zakat fitrah (3.5 liters of rice per person)
            const riceAmount = 3.5 * people; // in liters
            const zakatAmount = riceAmount * ricePrice;
            
            document.getElementById('zakat-fitrah-result').innerHTML = `<p class="text-amber-300">Zakat fitrah: ${riceAmount} liter beras atau Rp ${zakatAmount.toLocaleString('id-ID')}</p>`;
        });

        // --- Ayat Search Logic ---
        const ayatSearchInput = document.getElementById('ayat-search-input');
        const ayatSearchResults = document.getElementById('ayat-search-results');
        
        // Add debouncing to search input
        let searchTimeout;
        ayatSearchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = ayatSearchInput.value.trim();
            
            if (query.length < 3) {
                ayatSearchResults.innerHTML = '<p class="text-center text-gray-400">Masukkan minimal 3 karakter untuk pencarian.</p>';
                return;
            }
            
            showLoading();
            searchTimeout = setTimeout(() => {
                searchAyat(query);
            }, 500);
        });
        
        async function searchAyat(query) {
            try {
                // If we don't have Quran data yet, fetch it first
                if (!allQuranData) {
                    await fetchSurahList();
                }
                
                const results = [];
                let searchLimit = 8; // Batas maksimal hasil pencarian
                let foundCount = 0;
                
                // Search through all surahs and ayahs
                for (const surah of allQuranData) {
                    if (foundCount >= searchLimit) break; // Hentikan pencarian jika sudah mencapai batas
                    
                    const surahNumber = surah.number || surah.nomor;
                    
                    try {
                        let response, ayahs;
                        
                        if (currentApiSource === 'alquran-cloud') {
                            // Try primary API first
                            try {
                                response = await fetch(`https://alquran.cloud/api/surah/${surahNumber}/id.indonesian`);
                                if (!response.ok) throw new Error('Network response was not ok');
                                const data = await response.json();
                                ayahs = data.data.ayahs;
                            } catch (error) {
                                console.error('Primary API failed:', error);
                                // Try fallback API
                                response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/id.indonesian`);
                                if (!response.ok) throw new Error('Fallback API also failed');
                                const data = await response.json();
                                ayahs = data.data.ayahs;
                            }
                        } else {
                            // Use Santrikoding API
                            response = await fetch(`https://quran-api.santrikoding.com/api/surah/${surahNumber}`);
                            if (!response.ok) throw new Error('Network response was not ok');
                            const data = await response.json();
                            ayahs = data.ayat;
                        }
                        
                        // Search for matching ayahs
                        for (const ayah of ayahs) {
                            if (foundCount >= searchLimit) break; // Hentikan pencarian jika sudah mencapai batas
                            
                            const text = ayah.text || ayah.idn;
                            if (text && text.toLowerCase().includes(query.toLowerCase())) {
                                results.push({
                                    surahNumber: surahNumber,
                                    surahName: surah.englishName || surah.nama_latin,
                                    surahArabicName: surah.name || surah.nama,
                                    ayahNumber: ayah.numberInSurah || ayah.nomor,
                                    text: text
                                });
                                foundCount++;
                            }
                        }
                    } catch (error) {
                        console.error(`Error searching in surah ${surahNumber}:`, error);
                    }
                }
                
                renderSearchResults(results, query);
            } catch (error) {
                console.error('Error searching ayat:', error);
                ayatSearchResults.innerHTML = `<p class="text-red-400">Gagal mencari ayat: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }
        
        function renderSearchResults(results, query) {
            if (results.length === 0) {
                ayatSearchResults.innerHTML = `<p class="text-center text-gray-400">Tidak ada hasil untuk "${query}".</p>`;
                return;
            }
            
            ayatSearchResults.innerHTML = '';
            
            // Tampilkan semua hasil (maksimal 8)
            results.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.className = 'bg-emerald-800 bg-opacity-50 p-4 rounded-lg cursor-pointer hover:bg-emerald-700 transition-all duration-300';
                
                // Highlight the matching text
                const highlightedText = result.text.replace(
                    new RegExp(query, 'gi'),
                    match => `<span class="bg-amber-500 text-emerald-900 font-bold">${match}</span>`
                );
                
                resultItem.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg text-amber-300">${result.surahName} (${result.surahNumber}:${result.ayahNumber})</h3>
                    </div>
                    <p class="text-gray-300 leading-relaxed">${highlightedText}</p>
                `;
                
                resultItem.addEventListener('click', () => {
                    // Navigate to the surah detail view
                    fetchSurahDetail(result.surahNumber);
                    
                    // Switch to the Quran section
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    document.querySelector('[data-target="quran"]').classList.add('active');
                    
                    document.querySelectorAll('.content-section').forEach(section => section.classList.add('hidden'));
                    document.getElementById('quran-section').classList.remove('hidden');
                });
                
                ayatSearchResults.appendChild(resultItem);
            });
            
            // Tambahkan pesan jika ada lebih banyak hasil yang mungkin
            if (results.length === 8) {
                const moreResults = document.createElement('p');
                moreResults.className = 'text-center text-gray-400 mt-4';
                moreResults.textContent = 'Menampilkan 8 hasil teratas. Gunakan kata kunci yang lebih spesifik untuk hasil yang lebih tepat.';
                ayatSearchResults.appendChild(moreResults);
            }
        }

        // --- Doa Harian Logic ---
        const doaData = {
            makanan: [
                {
                    title: "Doa Sebelum Makan",
                    arabic: "ÿßŸÑŸÑŸëŸéŸáŸèŸÖŸëŸé ÿ®Ÿéÿßÿ±ŸêŸÉŸí ŸÑŸéŸÜŸéÿß ŸÅŸêŸäŸÖŸéÿß ÿ±Ÿéÿ≤ŸéŸÇŸíÿ™ŸéŸÜŸéÿß ŸàŸéŸÇŸêŸÜŸéÿß ÿπŸéÿ∞Ÿéÿßÿ®Ÿé ÿßŸÑŸÜŸëŸéÿßÿ±Ÿê",
                    latin: "Allahumma barik lana fima razaqtana wa qina 'adzaban nar",
                    translation: "Ya Allah, berkahilah kami dalam rezeki yang Engkau berikan kepada kami dan lindungilah kami dari siksa api neraka."
                },
                {
                    title: "Doa Sesudah Makan",
                    arabic: "ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸëŸéŸáŸê ÿßŸÑŸëŸéÿ∞ŸêŸä ÿ£Ÿéÿ∑ŸíÿπŸéŸÖŸéŸÜŸéÿß ŸàŸéÿ≥ŸéŸÇŸéÿßŸÜŸéÿß ŸàŸéÿ¨ŸéÿπŸéŸÑŸéŸÜŸéÿß ŸÖŸèÿ≥ŸíŸÑŸêŸÖŸêŸäŸÜŸé",
                    latin: "Alhamdulillahilladhi ath'amana wa saqana wa ja'alana muslimin",
                    translation: "Segala puji bagi Allah yang telah memberi makan kami dan minuman kami, serta menjadikan kami orang-orang Islam."
                }
            ],
            tidur: [
                {
                    title: "Doa Sebelum Tidur",
                    arabic: "ÿ®Ÿêÿßÿ≥ŸíŸÖŸêŸÉŸé ÿßŸÑŸÑŸëŸéŸáŸèŸÖŸëŸé ÿ£ŸéŸÖŸèŸàÿ™Ÿè ŸàŸéÿ£Ÿéÿ≠ŸíŸäŸéÿß",
                    latin: "Bismika Allahumma amutu wa ahya",
                    translation: "Dengan menyebut nama-Mu ya Allah, aku mati dan aku hidup."
                },
                {
                    title: "Doa Sesudah Tidur",
                    arabic: "ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸëŸéŸáŸê ÿßŸÑŸëŸéÿ∞ŸêŸä ÿ£Ÿéÿ≠ŸíŸäŸéÿßŸÜŸéÿß ÿ®ŸéÿπŸíÿØŸé ŸÖŸéÿß ÿ£ŸéŸÖŸéÿßÿ™ŸéŸÜŸéÿß ŸàŸéÿ•ŸêŸÑŸéŸäŸíŸáŸê ÿßŸÑŸÜŸëŸèÿ¥ŸèŸàÿ±Ÿè",
                    latin: "Alhamdulillahilladhi ahyana ba'da ma amata wa ilayhin nushur",
                    translation: "Segala puji bagi Allah yang telah menghidupkan kami sesudah kami mati (membangunkan dari tidur) dan hanya kepada-Nya kami dikembalikan."
                }
            ],
            rumah: [
                {
                    title: "Doa Masuk Rumah",
                    arabic: "ÿßŸÑŸÑŸëŸéŸáŸèŸÖŸëŸé ÿ•ŸêŸÜŸëŸêŸä ÿ£Ÿéÿ≥Ÿíÿ£ŸéŸÑŸèŸÉŸé ÿÆŸéŸäŸíÿ±Ÿé ÿßŸÑŸíŸÖŸéÿØŸíÿÆŸéŸÑŸê ŸàŸéÿÆŸéŸäŸíÿ±Ÿé ÿßŸÑŸíŸÖŸéÿÆŸíÿ±Ÿéÿ¨Ÿê ÿ®Ÿêÿßÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸéŸáŸê ŸàŸéŸÑŸéÿ¨ŸéŸÜŸéÿß ŸàŸéÿ®Ÿêÿßÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸéŸáŸê ÿÆŸéÿ±Ÿéÿ¨ŸíŸÜŸéÿß ŸàŸéÿπŸéŸÑŸéŸâ ÿßŸÑŸÑŸëŸéŸáŸê ÿ±Ÿéÿ®ŸëŸêŸÜŸéÿß ÿ™ŸéŸàŸéŸÉŸëŸéŸÑŸíŸÜŸéÿß",
                    latin: "Allahumma inni as'aluka khairal madkhali wa khairal makhraji bismillahi walajna wa bismillahi kharajna wa 'alallahi rabbina tawakkalna",
                    translation: "Ya Allah, sesungguhnya aku mohon kepada-Mu kebaikan saat masuk dan kebaikan saat keluar. Dengan nama Allah kami masuk, dan dengan nama Allah kami keluar, dan kepada Allah Tuhan kami, kami bertawakal."
                },
                {
                    title: "Doa Keluar Rumah",
                    arabic: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸéŸáŸê ÿ™ŸéŸàŸéŸÉŸëŸéŸÑŸíÿ™Ÿè ÿπŸéŸÑŸéŸâ ÿßŸÑŸÑŸëŸéŸáŸê ŸÑŸéÿß ÿ≠ŸéŸàŸíŸÑŸé ŸàŸéŸÑŸéÿß ŸÇŸèŸàŸëŸéÿ©Ÿé ÿ•ŸêŸÑŸëŸéÿß ÿ®ŸêÿßŸÑŸÑŸëŸéŸáŸê",
                    latin: "Bismillahi tawakkaltu 'alallahi la haula wa la quwwata illa billah",
                    translation: "Dengan nama Allah, aku bertawakal kepada Allah, tidak ada daya dan kekuatan kecuali dengan Allah."
                }
            ],
            wc: [
                {
                    title: "Doa Masuk WC",
                    arabic: "ÿßŸÑŸÑŸëŸéŸáŸèŸÖŸëŸé ÿ•ŸêŸÜŸëŸêŸä ÿ£ŸéÿπŸèŸàÿ∞Ÿè ÿ®ŸêŸÉŸé ŸÖŸêŸÜŸé ÿßŸÑŸíÿÆŸèÿ®Ÿèÿ´Ÿê ŸàŸéÿßŸÑŸíÿÆŸéÿ®Ÿéÿßÿ¶Ÿêÿ´Ÿê",
                    latin: "Allahumma inni a'udzu bika minal khubutsi wal khabaits",
                    translation: "Ya Allah, aku berlindung kepada-Mu dari godaan setan laki-laki dan setan perempuan."
                },
                {
                    title: "Doa Keluar WC",
                    arabic: "ÿ∫ŸèŸÅŸíÿ±ŸéÿßŸÜŸéŸÉŸé",
                    latin: "Ghufranaka",
                    translation: "Aku memohon ampunan kepada-Mu."
                }
            ],
            pakaian: [
                {
                    title: "Doa Memakai Pakaian Baru",
                    arabic: "ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸëŸéŸáŸê ÿßŸÑŸëŸéÿ∞ŸêŸä ŸÉŸéÿ≥ŸéÿßŸÜŸêŸä ŸáŸéÿ∞Ÿéÿß ŸàŸéÿ±Ÿéÿ≤ŸéŸÇŸéŸÜŸêŸäŸáŸê ŸÖŸêŸÜŸí ÿ∫ŸéŸäŸíÿ±Ÿê ÿ≠ŸéŸàŸíŸÑŸç ŸÖŸêŸÜŸëŸêŸä ŸàŸéŸÑŸéÿß ŸÇŸèŸàŸëŸéÿ©Ÿç",
                    latin: "Alhamdulillahilladhi kasani hadza wa razaqanihi min ghairi haulin minni wa la quwwah",
                    translation: "Segala puji bagi Allah yang telah memberikan aku pakaian ini dan memberikan rezeki kepadaku tanpa daya dan kekuatan dariku."
                }
            ]
        };

        function loadDoaCategories() {
            // Populate the doa list with the first category by default
            const firstCategory = Object.keys(doaData)[0];
            doaCategory.value = firstCategory;
            loadDoa();
        }

        loadDoaBtn.addEventListener('click', loadDoa);

        function loadDoa() {
            const category = doaCategory.value;
            
            if (!category) {
                doaListContainer.innerHTML = '<p class="text-center text-gray-400">Silakan pilih kategori doa.</p>';
                return;
            }
            
            const doas = doaData[category];
            
            if (!doas || doas.length === 0) {
                doaListContainer.innerHTML = '<p class="text-center text-gray-400">Tidak ada doa dalam kategori ini.</p>';
                return;
            }
            
            doaListContainer.innerHTML = '';
            
            doas.forEach(doa => {
                const doaCard = document.createElement('div');
                doaCard.className = 'bg-emerald-800 bg-opacity-50 p-4 rounded-lg';
                
                doaCard.innerHTML = `
                    <h3 class="font-bold text-lg text-amber-300 mb-2">${doa.title}</h3>
                    <p class="font-amiri text-2xl text-right leading-loose text-amber-100 mb-2">${doa.arabic}</p>
                    <p class="text-sm text-gray-400 mb-2">${doa.latin}</p>
                    <p class="text-gray-300">${doa.translation}</p>
                `;
                
                doaListContainer.appendChild(doaCard);
            });
        }

        // --- Hijaiyah Practice Logic ---
        let hijaiyahInitialized = false;
        const hijaiyahLetters = [
            'ÿß', 'ÿ®', 'ÿ™', 'ÿ´', 'ÿ¨', 'ÿ≠', 'ÿÆ', 'ÿØ', 'ÿ∞', 'ÿ±', 'ÿ≤', 'ÿ≥', 'ÿ¥', 'ÿµ', 
            'ÿ∂', 'ÿ∑', 'ÿ∏', 'ÿπ', 'ÿ∫', 'ŸÅ', 'ŸÇ', 'ŸÉ', 'ŸÑ', 'ŸÖ', 'ŸÜ', 'Ÿá', 'Ÿà', 'Ÿä'
        ];
        let currentLetterIndex = 0;
        let letterProgress = new Array(hijaiyahLetters.length).fill(false);
        
        function initializeHijaiyah() {
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            const nextButton = document.getElementById('nextButton');
            const clearButton = document.getElementById('clearButton');
            const targetLetter = document.getElementById('targetLetter');
            const feedbackText = document.getElementById('feedbackText');
            const progressBar = document.getElementById('progressBar');
            const currentScore = document.getElementById('currentScore');
            const lettersGrid = document.getElementById('lettersGrid');
            
            // Set up canvas
            ctx.strokeStyle = '#00a8a8';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Initialize letters grid
            renderLettersGrid();
            
            // Show the first letter
            showCurrentLetter();
            
            // Drawing functions
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = getMousePos(canvas, e);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const [currentX, currentY] = getMousePos(canvas, e);
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                
                [lastX, lastY] = [currentX, currentY];
            }
            
            function stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    evaluateDrawing();
                }
            }
            
            function getMousePos(canvas, e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                return [
                    clientX - rect.left,
                    clientY - rect.top
                ];
            }
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(e);
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e);
            });
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopDrawing();
            });
            
            // Button events
            nextButton.addEventListener('click', () => {
                // Mark current letter as completed
                letterProgress[currentLetterIndex] = true;
                
                // Move to next letter
                currentLetterIndex = (currentLetterIndex + 1) % hijaiyahLetters.length;
                
                // Update UI
                showCurrentLetter();
                renderLettersGrid();
                clearCanvas();
            });
            
            clearButton.addEventListener('click', clearCanvas);
            
            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                feedbackText.textContent = 'Silakan gambar huruf target di atas kanvas.';
                progressBar.style.width = '0%';
                currentScore.textContent = '0%';
            }
            
            function showCurrentLetter() {
                targetLetter.textContent = hijaiyahLetters[currentLetterIndex];
            }
            
            function renderLettersGrid() {
                lettersGrid.innerHTML = '';
                
                hijaiyahLetters.forEach((letter, index) => {
                    const letterItem = document.createElement('div');
                    letterItem.className = 'letter-item';
                    
                    if (letterProgress[index]) {
                        letterItem.classList.add('completed');
                    } else if (index === currentLetterIndex) {
                        letterItem.classList.add('current');
                    }
                    
                    letterItem.textContent = letter;
                    lettersGrid.appendChild(letterItem);
                });
            }
            
            function evaluateDrawing() {
                // This is a simplified evaluation - in a real app, you'd use more sophisticated pattern recognition
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                
                // Count non-transparent pixels
                let drawnPixels = 0;
                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] > 0) {
                        drawnPixels++;
                    }
                }
                
                // Calculate coverage percentage
                const totalPixels = canvas.width * canvas.height;
                const coveragePercent = (drawnPixels / totalPixels) * 100;
                
                // Update UI with feedback
                if (coveragePercent < 1) {
                    feedbackText.textContent = 'Gambar tidak terdeteksi. Silakan coba lagi.';
                    progressBar.style.width = '0%';
                    currentScore.textContent = '0%';
                } else if (coveragePercent < 3) {
                    feedbackText.textContent = 'Huruf terlalu kecil. Silakan gambar lebih besar.';
                    progressBar.style.width = '20%';
                    currentScore.textContent = '20%';
                } else if (coveragePercent < 6) {
                    feedbackText.textContent = 'Cukup baik, tapi bisa lebih baik lagi.';
                    progressBar.style.width = '40%';
                    currentScore.textContent = '40%';
                } else if (coveragePercent < 10) {
                    feedbackText.textContent = 'Bagus! Terus berlatih.';
                    progressBar.style.width = '60%';
                    currentScore.textContent = '60%';
                } else if (coveragePercent < 15) {
                    feedbackText.textContent = 'Sangat baik!';
                    progressBar.style.width = '80%';
                    currentScore.textContent = '80%';
                } else {
                    feedbackText.textContent = 'Luar biasa! Huruf sempurna.';
                    progressBar.style.width = '100%';
                    currentScore.textContent = '100%';
                }
            }
        }

        // --- Bookmark Logic ---
        function toggleBookmark(dataset) {
            const { surahNumber, ayahNumber, surahName, ayahText, translation } = dataset;
            const id = `${surahNumber}:${ayahNumber}`;

            const transaction = db.transaction(['bookmarks'], 'readwrite');
            const store = transaction.objectStore('bookmarks');
            const request = store.get(id);

            request.onsuccess = () => {
                if (request.result) {
                    // Already bookmarked, so remove it
                    store.delete(id).onsuccess = () => {
                        showNotification(`Bookmark QS ${surahName} ${surahNumber}:${ayahNumber} dihapus.`);
                    };
                } else {
                    // Not bookmarked, so add it
                    const bookmark = { id, surahNumber, ayahNumber, surahName, ayahText, translation };
                    store.add(bookmark).onsuccess = () => {
                        showNotification(`QS ${surahName} ${surahNumber}:${ayahNumber} ditambahkan ke bookmark.`);
                    };
                }
            };
        }

        function loadBookmarks() {
            if (!db) {
                bookmarkListContainer.innerHTML = '<p class="text-red-400">Database belum siap. Coba lagi nanti.</p>';
                return;
            }
            bookmarkListContainer.innerHTML = '<p class="text-center text-gray-400">Memuat bookmark...</p>';
            const transaction = db.transaction(['bookmarks'], 'readonly');
            const store = transaction.objectStore('bookmarks');
            const request = store.getAll();

            request.onsuccess = () => {
                const bookmarks = request.result;
                if (bookmarks.length === 0) {
                    bookmarkListContainer.innerHTML = '<p class="text-center text-gray-400">Anda belum memiliki bookmark.</p>';
                    return;
                }

                bookmarkListContainer.innerHTML = '';
                bookmarks.sort((a, b) => parseInt(a.surahNumber) - parseInt(b.surahNumber) || parseInt(a.ayahNumber) - parseInt(b.ayahNumber)).forEach(bookmark => {
                    const card = document.createElement('div');
                    card.className = 'bg-emerald-800 bg-opacity-50 p-4 rounded-lg';
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-lg text-amber-300">${bookmark.surahName} (${bookmark.surahNumber}:${bookmark.ayahNumber})</h3>
                            <button class="remove-bookmark-btn text-red-400 hover:text-red-600" data-id="${bookmark.id}">Hapus</button>
                        </div>
                        <p class="font-amiri text-xl text-right leading-loose text-amber-100 mb-3">${bookmark.ayahText}</p>
                        <p class="text-gray-300 leading-relaxed">${bookmark.translation}</p>
                    `;
                    card.querySelector('.remove-bookmark-btn').addEventListener('click', (e) => {
                        const idToRemove = e.target.dataset.id;
                        const tx = db.transaction(['bookmarks'], 'readwrite');
                        tx.objectStore('bookmarks').delete(idToRemove);
                        tx.oncomplete = () => {
                            showNotification('Bookmark dihapus.');
                            loadBookmarks(); // Refresh list
                        };
                    });
                    bookmarkListContainer.appendChild(card);
                });
            };

            request.onerror = (event) => {
                bookmarkListContainer.innerHTML = '<p class="text-red-400">Gagal memuat bookmark.</p>';
                console.error("Error loading bookmarks:", event.target.errorCode);
            };
        }

        // --- Hijri Calendar Logic ---
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const hijriMonthYearEl = document.getElementById('hijri-month-year');
        const hijriCalendarGrid = document.getElementById('hijri-calendar-grid');
        let currentCalendarDate = new Date();

        async function renderHijriCalendar(year, month) {
            showLoading();
            hijriCalendarGrid.innerHTML = ''; // Clear previous calendar

            // Add day headers
            const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            days.forEach(day => {
                hijriCalendarGrid.innerHTML += `<div class="font-bold text-amber-300 p-2">${day}</div>`;
            });

            try {
                const response = await fetch(`https://api.aladhan.com/v1/calendar/${year}/${month}`);
                if (!response.ok) throw new Error('Gagal memuat data kalender.');
                const data = await response.json();

                if (data.code === 200 && data.data.length > 0) {
                    // Pemetaan dari nama hari Inggris (dari API) ke singkatan Indonesia
                    const dayMap = {
                        "Sunday": "Min", "Monday": "Sen", "Tuesday": "Sel", 
                        "Wednesday": "Rab", "Thursday": "Kam", "Friday": "Jum", 
                        "Saturday": "Sab"
                    };

                    const firstDayOfMonth = data.data[0].date.gregorian.weekday.en;
                    const firstDayIndonesian = dayMap[firstDayOfMonth];
                    const firstDayIndex = days.indexOf(firstDayIndonesian);

                    // Set calendar title
                    const sampleDate = data.data[15]; // Use a mid-month date to be safe
                    hijriMonthYearEl.textContent = `${sampleDate.date.hijri.month.en} ${sampleDate.date.hijri.year} H / ${sampleDate.date.gregorian.month.en} ${sampleDate.date.gregorian.year} M`;

                    // Add empty cells for days before the 1st of the month
                    for (let i = 0; i < firstDayIndex; i++) {
                        hijriCalendarGrid.innerHTML += '<div></div>';
                    }

                    // Populate calendar with dates
                    data.data.forEach(dayData => {
                        const dayCell = document.createElement('div');
                        const gregorianDate = dayData.date.gregorian.day;
                        const hijriDate = dayData.date.hijri.day;
                        const isToday = new Date().toDateString() === new Date(dayData.date.gregorian.date).toDateString();

                        dayCell.className = `p-2 border border-emerald-700 rounded-md ${isToday ? 'bg-amber-500 text-emerald-900 font-bold' : 'bg-emerald-900'}`;
                        dayCell.innerHTML = `
                            <div class="text-lg">${gregorianDate}</div>
                            <div class="text-xs text-gray-400 ${isToday ? 'text-emerald-800' : ''}">${hijriDate}</div>
                        `;
                        hijriCalendarGrid.appendChild(dayCell);
                    });
                } else {
                    hijriCalendarGrid.innerHTML = '<p class="col-span-7 text-red-400">Tidak dapat mengambil data kalender.</p>';
                }
            } catch (error) {
                console.error('Error fetching Hijri calendar:', error);
                hijriCalendarGrid.innerHTML = `<p class="col-span-7 text-red-400">Error: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderHijriCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderHijriCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1);
        });

        // --- Service Worker Registration ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => console.log('Service Worker registered successfully:', registration))
                        .catch(error => console.log('Service Worker registration failed:', error));
                });
            }
        }


        // Initialize the app
        initDB();
        fetchSurahList();
        registerServiceWorker();
    });
</script>
</body>
</html>
